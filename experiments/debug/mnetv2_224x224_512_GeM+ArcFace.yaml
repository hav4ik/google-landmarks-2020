# Information about the experiment
experiment:
  name: mnetv2_224x224_512_GAP+ArcFace_debug
  storage: gs://glc2020-chankhavu-experiments/test
  mode: debug
  description: >
    This is a toy experiment using MobileNetV2 as backbone.
    The main purpose of this experiment is just for local
    testing (and maybe some toy training).



# Competition-specific configuration
glc_config:
  gld_version: gld_v2_clean
  gld_id_mapping: gs://gld-v2-clean/gld-v2-clean-id-mapping.csv



# Configure the dataset feeding pipeline
dataset_config:
  image_size: [224, 224, 3]
  imagenet_crop: false

  train_tfrecords:
    tfrecord_dir: gs://gld-v2-clean/gldv2_dataset/tfrecord/
    basename: validation
    shards: 128

  validation_tfrecords:
    tfrecord_dir: gs://gld-v2-clean/gldv2_dataset/tfrecord/
    basename: validation
    shards: 128

  train_shuffle:
    buffer_size: 40
    seed: 17061998

  train_augmentations:
    # Using only horizontal flips, as in Keetar's solution
    - class: TFImageTransform
      kwargs:
        horizontal_flip: true
        vertical_flip: false
        brightness_adjustments: false



# Model configurations
model_config:

  # Backbone CNN configuration
  backbone_config:
    architecture: MobileNetV2
    weights: imagenet
    trainable: true

  # Global branch: [backbone]->[pooling]->[dense]->[head]
  global_branch_config:
    # Currently, the following pooling methods are supported:
    #   - GAP()
    #   - GeM(p=3, train_p=True)
    pooling_config:
      method: GAP
      kwargs: {}

    # Embedding after pooling (output units of a Dense layer
    # without activation function because the backbone already
    # have it, and without bias.
    embedding_dim: 512

    # Currently, the following heads are supported:
    #   - ArcFace(s=30, m=0.5)
    #   - ArcMarginProduct(s=30, m=0.5, easy_margin=False)
    #   - AdaCos(m=0.5, is_dynamic=True)
    #   - CosFace(s=30, m=0.35)
    head_config:
      layer: ArcFace
      kwargs:
        s: 30.0
        m: 0.5

  # Local features extractor
  local_branch_config: null



# Configuration of the training process
training_config:
  batch_size:
    v: 2
    tpu: lin

  epochs: 2
  samples_per_epoch: 2

  optimizer:
    algorithm: SGD
    kwargs:
      learning_rate:
        v: 0.001 # 1e-3
        tpu: sqrt
      momentum: 0.9
      decay: 0.00001 # 1e-5

  learning_rate_scheduler: null

  additional_callbacks:
    - callback: EarlyStopping
      kwargs:
        monitor: val_loss
        patience: 5
